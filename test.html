<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VixFlix</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#141414;color:#fff;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6}
    header{position:fixed;top:0;left:0;right:0;z-index:100;background:linear-gradient(180deg,rgba(0,0,0,.9)0%,rgba(0,0,0,.7)70%,transparent 100%);backdrop-filter:blur(10px);padding:1rem 4%;display:flex;justify-content:space-between;align-items:center;transition:background .3s}
    header.scrolled{background:rgba(0,0,0,.95)}
    .logo{font-size:2rem;font-weight:700;color:#e50914;text-shadow:2px 2px 4px rgba(0,0,0,.8)}
    #search{padding:12px 20px;font-size:1rem;width:350px;border:2px solid rgba(255,255,255,.2);border-radius:25px;background:rgba(0,0,0,.7);color:#fff;outline:none;transition:all .3s}
    #search:focus{border-color:#e50914;box-shadow:0 0 20px rgba(229,9,20,.3);transform:scale(1.02)}
    main{margin-top:80px}
    .hero{height:70vh;background:linear-gradient(45deg,#e50914,#b20710);display:flex;align-items:center;justify-content:center;text-align:center;margin-bottom:3rem}
    .hero-content h1{font-size:4rem;margin-bottom:1rem;text-shadow:3px 3px 6px rgba(0,0,0,.8)}
    .hero-content p{font-size:1.5rem;opacity:.9;max-width:600px;margin:0 auto}
    section{margin:3rem 0}
    section h2{font-size:2rem;margin-bottom:1.5rem;padding-left:4%;color:#fff;position:relative}
    section h2::before{content:'';position:absolute;left:4%;bottom:-5px;width:60px;height:3px;background:#e50914}
    .carousel-container{position:relative;margin:0 4%}
    .carousel{display:flex;overflow-x:auto;gap:1rem;scroll-snap-type:x mandatory;scroll-behavior:smooth;padding:0 50px}
    .carousel::-webkit-scrollbar{display:none}
    .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.8);color:#fff;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:1.2rem;z-index:10;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px);transition:all .3s}
    .carousel-btn.prev{left:5px}.carousel-btn.next{right:5px}
    .carousel-btn:hover{background:rgba(229,9,20,.9);transform:translateY(-50%) scale(1.1);box-shadow:0 4px 15px rgba(229,9,20,.4)}
    .card{min-width:200px;cursor:pointer;transition:all .3s;scroll-snap-align:start;position:relative;border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.3)}
    .card img{width:100%;height:300px;object-fit:cover;transition:transform .3s}
    .card .info{position:absolute;bottom:0;left:0;width:100%;background:linear-gradient(transparent,rgba(0,0,0,.9));padding:20px 10px 10px;font-size:.9rem;text-align:center;font-weight:600;transform:translateY(100%);transition:transform .3s}
    .card:hover img{transform:scale(1.1)}.card:hover .info{transform:translateY(0)}
    #results{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:2rem;padding:2rem 4%}
    #player{display:none;padding:2rem 4%;min-height:100vh}
    .player-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}
    .back-btn{background:#e50914;color:#fff;border:none;padding:12px 24px;border-radius:25px;cursor:pointer;font-size:1rem;display:flex;gap:10px;align-items:center}
    .player-info{background:linear-gradient(135deg,rgba(229,9,20,.1),rgba(0,0,0,.8));border-radius:12px;padding:2rem;margin-bottom:2rem;backdrop-filter:blur(10px);border:1px solid rgba(229,9,20,.2)}
    .player-info h1{font-size:2.5rem;margin-bottom:1rem;color:#e50914;text-shadow:2px 2px 4px rgba(0,0,0,.5)}
    .player-content{display:grid;grid-template-columns:1fr 300px;gap:2rem}
    .video-container{position:relative;border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.5)}
    iframe#player-iframe{width:100%;height:60vh;border:none}
    .episode-selector{background:rgba(255,255,255,.08);border-radius:12px;padding:1.5rem;backdrop-filter:blur(10px)}
    .episodes-list{max-height:400px;overflow-y:auto}
    .episode-item{padding:12px;margin-bottom:8px;background:rgba(255,255,255,.03);border-radius:8px;cursor:pointer;border:2px solid transparent}
    .episode-item.active{background:rgba(229,9,20,.18);border-color:#e50914}
    .continue-controls{display:flex;gap:10px;align-items:center;justify-content:flex-end;padding:0 4%;margin-top:.5rem}
    .continue-controls button{background:rgba(255,255,255,.06);color:#fff;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:8px;cursor:pointer}
    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#e50914;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:768px){.player-content{grid-template-columns:1fr}#search{width:250px}.card{min-width:150px}}
  </style>
</head>
<body>
  <header id="header">
    <div class="logo">VixFlix</div>
    <div class="search-container"><input id="search" type="text" placeholder="üîç Cerca film, serie TV..." /></div>
  </header>

  <main>
    <div id="home">
      <section class="hero">
        <div class="hero-content">
          <h1>Benvenuto su VixFlix</h1>
          <p>Scopri migliaia di film e serie TV in streaming</p>
        </div>
      </section>

      <!-- continue-watching injected by JS -->

      <section id="trending">
        <h2>üî• Trending</h2>
        <div class="carousel-container">
          <button class="carousel-btn prev" onclick="scrollCarousel('trending', -1)">‚Äπ</button>
          <div class="carousel"></div>
          <button class="carousel-btn next" onclick="scrollCarousel('trending', 1)">‚Ä∫</button>
        </div>
      </section>

      <section id="nowPlaying">
        <h2>üé¨ Ultimi Film</h2>
        <div class="carousel-container">
          <button class="carousel-btn prev" onclick="scrollCarousel('nowPlaying', -1)">‚Äπ</button>
          <div class="carousel"></div>
          <button class="carousel-btn next" onclick="scrollCarousel('nowPlaying', 1)">‚Ä∫</button>
        </div>
      </section>

      <section id="popularMovies">
        <h2>‚≠ê Film Popolari</h2>
        <div class="carousel-container">
          <button class="carousel-btn prev" onclick="scrollCarousel('popularMovies', -1)">‚Äπ</button>
          <div class="carousel"></div>
          <button class="carousel-btn next" onclick="scrollCarousel('popularMovies', 1)">‚Ä∫</button>
        </div>
      </section>

      <section id="onTheAir">
        <h2>üì∫ Ultime Serie</h2>
        <div class="carousel-container">
          <button class="carousel-btn prev" onclick="scrollCarousel('onTheAir', -1)">‚Äπ</button>
          <div class="carousel"></div>
          <button class="carousel-btn next" onclick="scrollCarousel('onTheAir', 1)">‚Ä∫</button>
        </div>
      </section>

      <section id="popularTV">
        <h2>üèÜ Serie Popolari</h2>
        <div class="carousel-container">
          <button class="carousel-btn prev" onclick="scrollCarousel('popularTV', -1)">‚Äπ</button>
          <div class="carousel"></div>
          <button class="carousel-btn next" onclick="scrollCarousel('popularTV', 1)">‚Ä∫</button>
        </div>
      </section>
    </div>

    <div id="results"></div>

    <div id="player">
      <div class="player-header">
        <div style="display:flex;gap:10px;align-items:center;">
          <button class="back-btn" onclick="goBack()">‚Üê Torna indietro</button>
          <div style="color:rgba(255,255,255,.7);font-size:.9rem;">Se premi Indietro verr√† fermata la riproduzione</div>
        </div>
        <div style="display:flex;gap:10px;">
          <button onclick="clearLastWatched()" title="Rimuovi elemento 'Continua a guardare'">Rimuovi Continua</button>
        </div>
      </div>

      <div class="player-info" id="player-info">
        <h1 id="player-title"></h1>
        <div class="meta" id="player-meta"></div>
        <div class="overview" id="player-overview"></div>
      </div>

      <div class="player-content">
        <div class="video-container" id="video-container">
          <!-- iframe WITHOUT sandbox so provider scripts/postMessage can work -->
          <iframe id="player-iframe" allowfullscreen></iframe>
        </div>

        <div class="episode-selector" id="episode-selector" style="display:none;">
          <h3>Seleziona episodio</h3>
          <div class="season-selector">
            <label>Stagione:</label>
            <select id="season-select"></select>
          </div>
          <div class="episodes-list" id="episodes-list"></div>

          <div style="margin-top:12px;">
            <button onclick="saveCurrentTimestampManually()">Salva timestamp corrente</button>
            <div style="margin-top:8px;color:rgba(255,255,255,.7);font-size:.9rem;">
              Nota: se il provider nel frame supporta postMessage salveremo automaticamente currentTime.
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_KEY = '8265bd1679663a7ea12ac168da84d2e8';
    const endpoints = {
      trending: 'trending/all/week',
      nowPlaying: 'movie/now_playing',
      popularMovies: 'movie/popular',
      onTheAir: 'tv/on_the_air',
      popularTV: 'tv/popular'
    };

    let currentItem = null;
    let currentSeasons = [];
    let timestampPollInterval = null;
    let ytPlayer = null;
    let nativeVideo = null;

    function ensureYouTubeAPI(cb) {
      if (window.YT && window.YT.Player) return cb();
      const s = document.createElement('script');
      s.src = "https://www.youtube.com/iframe_api";
      window.onYouTubeIframeAPIReady = cb;
      document.head.appendChild(s);
    }

    window.addEventListener('scroll', () => {
      const header = document.getElementById('header');
      if (window.scrollY > 50) header.classList.add('scrolled'); else header.classList.remove('scrolled');
    });

    async function fetchList(type) {
      const res = await fetch(`https://api.themoviedb.org/3/${endpoints[type]}?api_key=${API_KEY}&language=it-IT`);
      const j = await res.json();
      return j.results || [];
    }

    async function fetchTVSeasons(tvId) {
      const res = await fetch(`https://api.themoviedb.org/3/tv/${tvId}?api_key=${API_KEY}&language=it-IT`);
      const data = await res.json();
      return data.seasons || [];
    }

    async function fetchSeasonEpisodes(tvId, seasonNumber) {
      const res = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${API_KEY}&language=it-IT`);
      const data = await res.json();
      return data.episodes || [];
    }

    function makeCard(item) {
      const div = document.createElement('div');
      div.className = 'card';
      const posterPath = item.poster_path ? `https://image.tmdb.org/t/p/w300${item.poster_path}` : 'https://via.placeholder.com/300x450/333/fff?text=No+Image';
      div.innerHTML = `<img src="${posterPath}" alt="${item.title || item.name}"><div class="info">${item.title || item.name}</div>`;
      div.onclick = () => { div.classList.add('clicked'); setTimeout(() => play(item), 300); };
      return div;
    }

    function fillSection(sectionId, items) {
      const carousel = document.querySelector(`#${sectionId} .carousel`);
      if (!carousel) return;
      carousel.innerHTML = '';
      items.slice(0,20).forEach(item => carousel.appendChild(makeCard(item)));
      updateCarouselButtons(sectionId);
    }

    function scrollCarousel(sectionId, direction) {
      const carousel = document.querySelector(`#${sectionId} .carousel`);
      if (!carousel) return;
      const scrollAmount = 220;
      const currentScroll = carousel.scrollLeft;
      const targetScroll = currentScroll + (direction * scrollAmount * 3);
      carousel.scrollTo({ left: targetScroll, behavior: 'smooth' });
      setTimeout(() => updateCarouselButtons(sectionId), 300);
    }

    function updateCarouselButtons(sectionId) {
      const carousel = document.querySelector(`#${sectionId} .carousel`);
      const prevBtn = document.querySelector(`#${sectionId} .carousel-btn.prev`);
      const nextBtn = document.querySelector(`#${sectionId} .carousel-btn.next`);
      if (!carousel || !prevBtn || !nextBtn) return;
      prevBtn.disabled = carousel.scrollLeft <= 0;
      nextBtn.disabled = carousel.scrollLeft >= (carousel.scrollWidth - carousel.clientWidth);
    }

    async function loadHome() {
      try {
        const [trending, np, pm, ota, ptv] = await Promise.all([
          fetchList('trending'),
          fetchList('nowPlaying'),
          fetchList('popularMovies'),
          fetchList('onTheAir'),
          fetchList('popularTV')
        ]);
        fillSection('trending', trending);
        fillSection('nowPlaying', np);
        fillSection('popularMovies', pm);
        fillSection('onTheAir', ota);
        fillSection('popularTV', ptv);

        ['trending','nowPlaying','popularMovies','onTheAir','popularTV'].forEach(sectionId => {
          const carousel = document.querySelector(`#${sectionId} .carousel`);
          if (carousel) carousel.addEventListener('scroll', () => updateCarouselButtons(sectionId));
        });

        showContinueWatching();
      } catch (e) {
        console.error('Errore nel caricamento:', e);
      }
    }

    function showContinueWatching() {
      const data = JSON.parse(localStorage.getItem('lastWatched'));
      const existing = document.getElementById('continueWatching');
      if (existing) existing.remove();
      if (!data) return;

      const section = document.createElement('section');
      section.id = 'continueWatching';
      let subtitle = '';
      if (data.type === 'tv') subtitle = `S${data.seasonNumber}E${data.episodeNumber}`;
      const titleEscaped = (data.title || 'Contenuto').replace(/"/g,'');
      const timeLabel = data.timestamp != null ? ` ‚Ä¢ ‚è±Ô∏è ${formatTime(data.timestamp)}` : '';
      section.innerHTML = `
        <h2>‚èØÔ∏è Continua a guardare</h2>
        <div class="carousel-container">
          <div class="carousel">
            <div class="card" onclick="resumeLastWatched()">
              <img src="https://via.placeholder.com/300x450/222/fff?text=${encodeURIComponent(titleEscaped)}" alt="${titleEscaped}">
              <div class="info">${titleEscaped} ${subtitle} ${timeLabel}</div>
            </div>
          </div>
        </div>
        <div class="continue-controls">
          <div style="color:rgba(255,255,255,.7);font-size:.9rem;">Salvato il: ${new Date(data.savedAt || Date.now()).toLocaleString()}</div>
          <button onclick="resumeLastWatched()">Riprendi</button>
          <button onclick="clearLastWatched()">Rimuovi</button>
        </div>
      `;
      const home = document.getElementById('home');
      home.insertBefore(section, home.children[1] || home.firstChild);
    }

    function clearLastWatched() {
      localStorage.removeItem('lastWatched');
      const el = document.getElementById('continueWatching');
      if (el) el.remove();
    }

    function resumeLastWatched() {
      const data = JSON.parse(localStorage.getItem('lastWatched'));
      if (!data) return;

      if (data.type === 'movie') {
        const url = buildUrlForMovie(data.id, data.timestamp);
        showPlayerForMovie(data.id, data.title, url);
      } else {
        play({ id: data.id, name: data.title });
        setTimeout(() => {
          const url = buildUrlForEpisode(data.id, data.seasonNumber, data.episodeNumber, data.timestamp);
          const iframe = document.getElementById('player-iframe');
          // restore iframe container if it was replaced by YT player earlier
          const container = document.getElementById('video-container');
          if (!container.querySelector('iframe')) {
            container.innerHTML = `<iframe id="player-iframe" allowfullscreen></iframe>`;
          }
          document.getElementById('player-iframe').src = url;
          startTimestampPolling();
        }, 700);
      }
    }

    function buildUrlForMovie(id, timestamp) {
      let url = `https://vixsrc.to/movie/${id}/?primaryColor=ff0000&lang=it`;
      if (timestamp != null) url += `&start=${Math.floor(timestamp)}`;
      return url;
    }

    function buildUrlForEpisode(tvId, seasonNumber, episodeNumber, timestamp) {
      let url = `https://vixsrc.to/tv/${tvId}/${seasonNumber}/${episodeNumber}/?primaryColor=ff0000&lang=it`;
      if (timestamp != null) url += `&start=${Math.floor(timestamp)}`;
      return url;
    }

    async function fetchItemDetails(item) {
      const isMovie = item.title !== undefined;
      const type = isMovie ? 'movie' : 'tv';
      const res = await fetch(`https://api.themoviedb.org/3/${type}/${item.id}?api_key=${API_KEY}&language=it-IT`);
      return await res.json();
    }

    async function play(item) {
      currentItem = item;
      const isMovie = item.title !== undefined;
      const id = item.id;
      const details = await fetchItemDetails(item);

      document.getElementById('player-title').textContent = item.title || item.name;
      document.getElementById('player-overview').textContent = details.overview || 'Nessuna descrizione disponibile.';
      const metaDiv = document.getElementById('player-meta');
      metaDiv.innerHTML = '';

      if (isMovie) {
        const year = details.release_date ? new Date(details.release_date).getFullYear() : 'N/A';
        const duration = details.runtime ? `${details.runtime} min` : 'N/A';
        const rating = details.vote_average ? `‚≠ê ${details.vote_average.toFixed(1)}` : 'N/A';
        metaDiv.innerHTML = `<span>üé¨ Film</span><span>üìÖ ${year}</span><span>‚è±Ô∏è ${duration}</span><span>${rating}</span>`;
      } else {
        const year = details.first_air_date ? new Date(details.first_air_date).getFullYear() : 'N/A';
        const seasons = details.number_of_seasons ? `${details.number_of_seasons} stagioni` : 'N/A';
        const rating = details.vote_average ? `‚≠ê ${details.vote_average.toFixed(1)}` : 'N/A';
        metaDiv.innerHTML = `<span>üì∫ Serie TV</span><span>üìÖ ${year}</span><span>üé≠ ${seasons}</span><span>${rating}</span>`;
      }

      document.getElementById('home').style.display = 'none';
      document.getElementById('results').style.display = 'none';
      document.getElementById('player').style.display = 'block';

      if (isMovie) {
        document.getElementById('episode-selector').style.display = 'none';
        const url = buildUrlForMovie(id, getSavedTimestampIfSame('movie', id));
        document.getElementById('player-iframe').src = url;

        localStorage.setItem('lastWatched', JSON.stringify({
          type: 'movie', id, title: item.title || item.name || 'Film', savedAt: Date.now(),
          timestamp: getSavedTimestampIfSame('movie', id) || null
        }));
        showContinueWatching();
        startTimestampPolling();
      } else {
        document.getElementById('episode-selector').style.display = 'block';
        await loadTVSeasons(id);
      }

      window.scrollTo(0,0);
    }

    function getSavedTimestampIfSame(type, id) {
      const data = JSON.parse(localStorage.getItem('lastWatched'));
      if (!data) return null;
      if (data.type === type && data.id == id) return data.timestamp || null;
      return null;
    }

    async function loadTVSeasons(tvId) {
      try {
        const seasons = await fetchTVSeasons(tvId);
        currentSeasons = seasons.filter(s => s.season_number > 0);
        const seasonSelect = document.getElementById('season-select');
        seasonSelect.innerHTML = '';

        currentSeasons.forEach(season => {
          const option = document.createElement('option');
          option.value = season.season_number;
          option.textContent = `Stagione ${season.season_number} (${season.episode_count} episodi)`;
          seasonSelect.appendChild(option);
        });

        const resume = JSON.parse(localStorage.getItem('lastWatched'));
        if (resume && resume.type === 'tv' && resume.id == tvId) {
          await loadSeasonEpisodes(tvId, resume.seasonNumber);
          playEpisode(tvId, resume.seasonNumber, resume.episodeNumber, resume.timestamp);
        } else {
          if (currentSeasons.length > 0) {
            await loadSeasonEpisodes(tvId, currentSeasons[0].season_number);
            playEpisode(tvId, currentSeasons[0].season_number, 1);
          }
        }

        seasonSelect.addEventListener('change', async (e) => {
          const seasonNumber = parseInt(e.target.value);
          await loadSeasonEpisodes(tvId, seasonNumber);
          playEpisode(tvId, seasonNumber, 1);
        });
      } catch (e) {
        console.error('Errore caricamento stagioni', e);
      }
    }

    async function loadSeasonEpisodes(tvId, seasonNumber) {
      try {
        const episodes = await fetchSeasonEpisodes(tvId, seasonNumber);
        const episodesList = document.getElementById('episodes-list');
        episodesList.innerHTML = '';
        episodes.forEach(ep => {
          const episodeDiv = document.createElement('div');
          episodeDiv.className = 'episode-item';
          episodeDiv.innerHTML = `<div class="episode-number">Episodio ${ep.episode_number}</div><div class="episode-title">${ep.name || `Episodio ${ep.episode_number}`}</div>`;
          episodeDiv.onclick = () => {
            document.querySelectorAll('.episode-item').forEach(el => el.classList.remove('active'));
            episodeDiv.classList.add('active');
            playEpisode(tvId, seasonNumber, ep.episode_number);
          };
          episodesList.appendChild(episodeDiv);
        });
        if (episodes.length > 0) episodesList.firstChild.classList.add('active');
      } catch (e) {
        console.error('Errore caricamento episodi', e);
      }
    }

    function playEpisode(tvId, seasonNumber, episodeNumber, forcedTimestamp = null) {
      const url = buildUrlForEpisode(tvId, seasonNumber, episodeNumber, forcedTimestamp || getSavedTimestampIfSame('tv', tvId));
      const iframe = document.getElementById('player-iframe');
      // restore iframe if replaced
      const container = document.getElementById('video-container');
      if (!container.querySelector('iframe')) container.innerHTML = `<iframe id="player-iframe" allowfullscreen></iframe>`;
      document.getElementById('player-iframe').src = url;

      localStorage.setItem('lastWatched', JSON.stringify({
        type: 'tv',
        id: tvId,
        title: currentItem && (currentItem.name || currentItem.title) ? (currentItem.name || currentItem.title) : `Serie ${tvId}`,
        seasonNumber,
        episodeNumber,
        savedAt: Date.now(),
        timestamp: forcedTimestamp || getSavedTimestampIfSame('tv', tvId) || null
      }));

      showContinueWatching();
      startTimestampPolling();
    }

    function goBack() {
      stopTimestampPolling();
      document.getElementById('player').style.display = 'none';
      document.getElementById('home').style.display = 'block';
      const container = document.getElementById('video-container');
      container.innerHTML = `<iframe id="player-iframe" allowfullscreen></iframe>`;
      showContinueWatching();
      window.scrollTo(0,0);
    }

    function saveCurrentTimestampManually() {
      const input = prompt('Inserisci il timestamp in secondi da salvare (es. 123):', '0');
      if (input === null) return;
      const seconds = parseInt(input, 10);
      if (isNaN(seconds) || seconds < 0) { alert('Valore non valido'); return; }
      const data = JSON.parse(localStorage.getItem('lastWatched')) || {};
      data.timestamp = seconds;
      data.savedAt = Date.now();
      localStorage.setItem('lastWatched', JSON.stringify(data));
      showContinueWatching();
      alert('Timestamp salvato: ' + formatTime(seconds));
    }

    function startTimestampPolling() {
      stopTimestampPolling();
      const iframe = document.getElementById('player-iframe');
      if (!iframe) return;
      const src = iframe.src || '';

      const ytMatch = src.match(/(?:youtube\.com\/watch\?v=|youtube\.com\/embed\/|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
      if (ytMatch) {
        const videoId = ytMatch[1];
        ensureYouTubeAPI(() => {
          const container = document.getElementById('video-container');
          container.innerHTML = `<div id="yt-player"></div>`;
          ytPlayer = new YT.Player('yt-player', {
            videoId,
            playerVars: { autoplay: 1, origin: location.origin },
            events: {
              onReady: function() {
                const data = JSON.parse(localStorage.getItem('lastWatched')) || {};
                const saved = data.timestamp || 0;
                if (saved) ytPlayer.seekTo(saved, true);
                timestampPollInterval = setInterval(() => {
                  try {
                    const t = Math.floor(ytPlayer.getCurrentTime());
                    const stored = JSON.parse(localStorage.getItem('lastWatched')) || {};
                    stored.timestamp = t;
                    stored.savedAt = Date.now();
                    localStorage.setItem('lastWatched', JSON.stringify(stored));
                    showContinueWatching();
                  } catch (e) {}
                }, 5000);
              }
            }
          });
        });
        return;
      }

      try {
        const cw = iframe.contentWindow;
        if (cw && typeof cw.document !== 'undefined') {
          const v = cw.document.querySelector('video');
          if (v) {
            nativeVideo = v;
            timestampPollInterval = setInterval(() => {
              try {
                const t = Math.floor(nativeVideo.currentTime);
                const stored = JSON.parse(localStorage.getItem('lastWatched')) || {};
                stored.timestamp = t;
                stored.savedAt = Date.now();
                localStorage.setItem('lastWatched', JSON.stringify(stored));
                showContinueWatching();
              } catch (e) {}
            }, 3000);
            return;
          }
        }
      } catch (e) {}

      timestampPollInterval = setInterval(() => {
        try { iframe.contentWindow.postMessage({ type:'REQUEST_CURRENT_TIME' }, '*'); } catch (e) {}
      }, 5000);
    }

    function stopTimestampPolling() {
      if (timestampPollInterval) { clearInterval(timestampPollInterval); timestampPollInterval = null; }
      if (ytPlayer) { try { ytPlayer.destroy(); } catch (e) {} ytPlayer = null; const container = document.getElementById('video-container'); container.innerHTML = `<iframe id="player-iframe" allowfullscreen></iframe>`; }
      nativeVideo = null;
    }

    window.addEventListener('message', (ev) => {
      if (!ev.data) return;
      const msg = ev.data;
      if (msg.type === 'CURRENT_TIME' && typeof msg.currentTime === 'number') {
        const data = JSON.parse(localStorage.getItem('lastWatched')) || {};
        data.timestamp = Math.floor(msg.currentTime);
        data.savedAt = Date.now();
        localStorage.setItem('lastWatched', JSON.stringify(data));
        showContinueWatching();
      }
      if (msg.currentTime && typeof msg.currentTime === 'number') {
        const data = JSON.parse(localStorage.getItem('lastWatched')) || {};
        data.timestamp = Math.floor(msg.currentTime);
        data.savedAt = Date.now();
        localStorage.setItem('lastWatched', JSON.stringify(data));
        showContinueWatching();
      }
    });

    function formatTime(sec) {
      if (sec == null) return '';
      const s = Number(sec);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const ss = Math.floor(s%60);
      return (h>0 ? h+':' : '') + String(m).padStart(h>0?2:1,'0') + ':' + String(ss).padStart(2,'0');
    }

    function showPlayerForMovie(id, title, url) {
      document.getElementById('home').style.display = 'none';
      document.getElementById('results').style.display = 'none';
      document.getElementById('player').style.display = 'block';
      document.getElementById('player-title').textContent = title || 'Film';
      document.getElementById('player-overview').textContent = '';
      const container = document.getElementById('video-container');
      container.innerHTML = `<iframe id="player-iframe" allowfullscreen src="${url}"></iframe>`;
      localStorage.setItem('lastWatched', JSON.stringify({ type:'movie', id, title, savedAt: Date.now(), timestamp: getSavedTimestampIfSame('movie', id) || null }));
      showContinueWatching();
      startTimestampPolling();
    }

    document.getElementById('search').addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const q = e.target.value.trim();
      if (!q) return;
      document.getElementById('home').style.display = 'none';
      document.getElementById('player').style.display = 'none';
      const resDiv = document.getElementById('results');
      resDiv.innerHTML = '<div class="loading"></div>';
      try {
        const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${API_KEY}&query=${encodeURIComponent(q)}&language=it-IT`);
        const data = await res.json();
        resDiv.innerHTML = '';
        if (!data.results || data.results.length === 0) {
          resDiv.innerHTML = '<p style="text-align:center;font-size:1.2rem;opacity:.7;">Nessun risultato trovato</p>';
        } else {
          data.results.forEach(item => resDiv.appendChild(makeCard(item)));
        }
      } catch (e) {
        console.error('Errore nella ricerca', e);
        resDiv.innerHTML = '<p style="text-align:center;color:#e50914;">Errore durante la ricerca</p>';
      }
    });

    // Initialize
    loadHome();
  </script>
</body>
</html>